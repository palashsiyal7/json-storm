<!DOCTYPE html>
<html>
  <head>
    <title>API Testing Tool</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    />
    <style>
      .container {
        max-width: 1200px;
        margin: 20px auto;
      }
      .response-log {
        max-height: 400px;
        overflow-y: auto;
      }
      .mongodb-section {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ddd;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-radius: 50%;
        border-top: 4px solid #3498db;
        width: 20px;
        height: 20px;
        animation: spin 2s linear infinite;
        display: none;
        margin-left: 10px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="d-flex justify-content-between align-items-center">
        API Testing Tool
        <a href="https://github.com/palashsiyal7/" target="_blank">
          <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub" width="50" height="50">
        </a>
      </h1>
      <!-- MongoDB Configuration -->
      <div class="mongodb-section">
        <h4>MongoDB Configuration</h4>
        <div class="row g-3">
          <div class="col-md-4">
            <input
              type="text"
              class="form-control"
              id="mongo-connection"
              placeholder="Connection String"
            />
          </div>
          <div class="col-md-3">
            <input
              type="text"
              class="form-control"
              id="mongo-database"
              placeholder="Database Name"
            />
          </div>
          <div class="col-md-3">
            <input
              type="text"
              class="form-control"
              id="mongo-collection"
              placeholder="Collection Name"
            />
          </div>
          <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="configureMongoDB()">
              Connect
            </button>
          </div>
        </div>
      </div>

      <!-- Request Configuration -->
      <div class="mt-4">
        <h4>Request Configuration</h4>
        <div class="row g-3 mb-3">
          <div class="col-md-8">
            <input
              type="url"
              class="form-control"
              id="endpoint"
              placeholder="API Endpoint ( http:// or https:// )"
            />
          </div>
          <div class="col-md-2">
            <input
              type="number"
              class="form-control"
              id="iterations"
              value="1"
              min="1"
              placeholder="Iterations"
            />
          </div>
          <div class="col-md-2 form-check d-flex align-items-center">
            <input
              type="checkbox"
              class="form-check-input"
              id="mongo-enabled"
            />
            <label class="form-check-label ms-2" for="mongo-enabled"
              >Store in MongoDB</label
            >
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">JSON Template:</label>
          <textarea
            class="form-control"
            id="json-template"
            rows="14"
            placeholder='Example:
{ 
    "user": "{{random_string}}", 
    "age": {{random_int}}, 
    "active": {{boolean}}, 
    "uuid": "{{uuid}}", 
    "score": {{random_float}} 
}
Options:
{{random_int}}: Random integer between 1-100
{{random_float}}: Random float between 0-1
{{random_string}}: 10-character random string
{{uuid}}: UUID v4 string
{{boolean}}: Random boolean (true/false)'
          ></textarea>
        </div>

        <div class="d-flex align-items-center">
          <button class="btn btn-success" id="run-test-btn" onclick="runTest()">Run Test</button>
          <div class="loader" id="loader"></div>
        </div>
      </div>

      <!-- Results -->
      <div class="mt-4">
        <h4>Results</h4>
        <div class="response-log card">
          <div class="card-body" id="results">
            <!-- Results will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function configureMongoDB() {
        const config = {
          connection_string: document.getElementById("mongo-connection").value,
          database: document.getElementById("mongo-database").value,
        };

        fetch("/configure_mongodb", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(config),
        })
          .then((response) => response.json())
          .then((data) => {
            alert(
              data.status === "success"
                ? "Connected to MongoDB!"
                : "Error: " + data.message
            );
          });
      }

      function runTest() {
        const runTestBtn = document.getElementById("run-test-btn");
        const loader = document.getElementById("loader");
        runTestBtn.style.display = "none";
        loader.style.display = "inline-block";

        const payload = {
          endpoint: document.getElementById("endpoint").value,
          iterations: parseInt(document.getElementById("iterations").value),
          template: document.getElementById("json-template").value,
          mongo_enabled: document.getElementById("mongo-enabled").checked,
          mongo_collection: document.getElementById("mongo-collection").value,
        };

        fetch("/run_test", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
          .then((response) => response.json())
          .then((data) => {
            runTestBtn.style.display = "inline-block";
            loader.style.display = "none";
            const resultsDiv = document.getElementById("results");
            resultsDiv.innerHTML = "";

            data.forEach((result) => {
              const div = document.createElement("div");
              div.className = `alert alert-${
                result.status === "completed" ? "success" : "danger"
              }`;

              let content = `Iteration ${result.iteration}: `;
              if (result.status === "completed") {
                content += `Status ${result.status_code} - Response: ${result.response}`;
              } else {
                content += `Error: ${result.error}`;
              }

              div.textContent = content;
              resultsDiv.appendChild(div);
            });
          })
          .catch((error) => {
            runTestBtn.style.display = "inline-block";
            loader.style.display = "none";
            alert("An error occurred: " + error.message);
          });
      }
    </script>
  </body>
</html>
